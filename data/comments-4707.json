[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/669319559",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4707#issuecomment-669319559",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4707",
        "id": 669319559,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTMxOTU1OQ==",
        "user": {
            "login": "liqunfu",
            "id": 3318051,
            "node_id": "MDQ6VXNlcjMzMTgwNTE=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3318051?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/liqunfu",
            "html_url": "https://github.com/liqunfu",
            "followers_url": "https://api.github.com/users/liqunfu/followers",
            "following_url": "https://api.github.com/users/liqunfu/following{/other_user}",
            "gists_url": "https://api.github.com/users/liqunfu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/liqunfu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/liqunfu/subscriptions",
            "organizations_url": "https://api.github.com/users/liqunfu/orgs",
            "repos_url": "https://api.github.com/users/liqunfu/repos",
            "events_url": "https://api.github.com/users/liqunfu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/liqunfu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-08-05T17:15:40Z",
        "updated_at": "2020-08-05T17:15:40Z",
        "author_association": "MEMBER",
        "body": "according to onnx.save_model, if you pass in 'f' a path, it will save external tensors which will avoid 2gb limit. May you give onnx_model_path a folder name and see what happens?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/669319559/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/669486745",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4707#issuecomment-669486745",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4707",
        "id": 669486745,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTQ4Njc0NQ==",
        "user": {
            "login": "klimentij",
            "id": 3247669,
            "node_id": "MDQ6VXNlcjMyNDc2Njk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3247669?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/klimentij",
            "html_url": "https://github.com/klimentij",
            "followers_url": "https://api.github.com/users/klimentij/followers",
            "following_url": "https://api.github.com/users/klimentij/following{/other_user}",
            "gists_url": "https://api.github.com/users/klimentij/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/klimentij/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/klimentij/subscriptions",
            "organizations_url": "https://api.github.com/users/klimentij/orgs",
            "repos_url": "https://api.github.com/users/klimentij/repos",
            "events_url": "https://api.github.com/users/klimentij/events{/privacy}",
            "received_events_url": "https://api.github.com/users/klimentij/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-08-05T20:29:40Z",
        "updated_at": "2020-08-05T20:29:40Z",
        "author_association": "NONE",
        "body": "@liqunfu unfortunately it didn't seem to help. I edited `onnx_model.py` file so that `save_model_to_file` function sends a folder name instead of file path to `onnx.save_model`:\r\n\r\n```\r\ndef save_model_to_file(self, output_path):\r\n        \r\n        output_folder = os.path.dirname(output_path)\r\n        \r\n        logger.info(f\"Output model to {output_path}\")\r\n        logger.info(f\"Output model to folder {output_folder}\")\r\n        \r\n\r\n        if output_path.endswith(\".json\"):\r\n            assert isinstance(self.model, ModelProto)\r\n            with open(output_path, \"w\") as out:\r\n                out.write(str(self.model))\r\n        else:\r\n            save_model(self.model, output_folder, format=None)\r\n            #external_data_helper.convert_model_to_external_data(self.model, all_tensors_to_one_file=True, location = output_path + \".data\")\r\n            #with open(output_path, \"wb\") as out:\r\n            #    out.write(self.model.SerializeToString())\r\n```\r\n\r\nI also made sure `f` is the second parameter in `save_model`:\r\n```\r\nsave_model(proto, f, format=None)\r\n````\r\n\r\nAccording to the log, this method is indeed called and `output_folder` is indeed a folder, but it didn't help:\r\n```\r\nOutput model to ./gpt2_xl_onnx_past/_past_fp16.onnx\r\nOutput model to folder ./gpt2_xl_onnx_past\r\nTraceback (most recent call last):\r\n  File \"benchmark_gpt2.py\", line 258, in <module>\r\n    main()\r\n  File \"benchmark_gpt2.py\", line 152, in main\r\n    model.config.num_attention_heads, model.config.hidden_size)\r\n  File \"/home/jupyter/onnxruntime/onnxruntime/python/tools/transformers/gpt2_helper.py\", line 252, in optimize_onnx\r\n    m.save_model_to_file(optimized_model_path)\r\n  File \"/home/jupyter/onnxruntime/onnxruntime/python/tools/transformers/onnx_model.py\", line 674, in save_model_to_file\r\n    save_model(self.model, output_folder, format=None)\r\n  File \"/opt/conda/lib/python3.7/site-packages/onnx/__init__.py\", line 186, in save_model\r\n    s = _serialize(proto)\r\n  File \"/opt/conda/lib/python3.7/site-packages/onnx/__init__.py\", line 67, in _serialize\r\n    result = proto.SerializeToString()\r\nValueError: Message ONNX_REL_1_7.ModelProto exceeds maximum protobuf size of 2GB: 3276141735\r\n```",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/669486745/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/669614832",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4707#issuecomment-669614832",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4707",
        "id": 669614832,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTYxNDgzMg==",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-08-06T00:33:35Z",
        "updated_at": "2020-08-06T00:33:35Z",
        "author_association": "MEMBER",
        "body": "@klimentij, I can reproduce the problem. I will try modify the save_model_to_file function and let you know when there is progress.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/669614832/reactions",
            "total_count": 2,
            "+1": 1,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 1,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/670070004",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4707#issuecomment-670070004",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4707",
        "id": 670070004,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDA3MDAwNA==",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-08-06T17:27:58Z",
        "updated_at": "2020-08-06T17:29:16Z",
        "author_association": "MEMBER",
        "body": "@klimentij, It seems that the following change could help export large model to ONNX:\r\n```\r\n    def save_model_to_file(self, output_path):\r\n            from pathlib import Path\r\n            external_data_helper.convert_model_to_external_data(self.model, all_tensors_to_one_file=True, location = Path(output_path).name + \".data\")       \r\n            save_model(self.model, output_path)\r\n```\r\nThe output model will contain two files like name.onnx and name.onnx.data. I'll send a pull request later after more testing.\r\n\r\nIt seems that the model is very large, so benchmark will get out of memory exception when both PyTorch model and ONNX model are loaded in V100 GPU (with 16GB memory). After ONNX model is exported, use ONNX model only might avoid the problem.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/670070004/reactions",
            "total_count": 2,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 2,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/670939351",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/4707#issuecomment-670939351",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/4707",
        "id": 670939351,
        "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDkzOTM1MQ==",
        "user": {
            "login": "klimentij",
            "id": 3247669,
            "node_id": "MDQ6VXNlcjMyNDc2Njk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3247669?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/klimentij",
            "html_url": "https://github.com/klimentij",
            "followers_url": "https://api.github.com/users/klimentij/followers",
            "following_url": "https://api.github.com/users/klimentij/following{/other_user}",
            "gists_url": "https://api.github.com/users/klimentij/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/klimentij/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/klimentij/subscriptions",
            "organizations_url": "https://api.github.com/users/klimentij/orgs",
            "repos_url": "https://api.github.com/users/klimentij/repos",
            "events_url": "https://api.github.com/users/klimentij/events{/privacy}",
            "received_events_url": "https://api.github.com/users/klimentij/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2020-08-08T15:05:52Z",
        "updated_at": "2020-08-08T15:05:52Z",
        "author_association": "NONE",
        "body": "Thank you @tianleiwu! I managed to export it to .onnx and .onnx.data files using the edit you suggested.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/670939351/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]