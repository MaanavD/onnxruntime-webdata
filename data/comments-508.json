[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/490757218",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/508#issuecomment-490757218",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/508",
        "id": 490757218,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MDc1NzIxOA==",
        "user": {
            "login": "jaliyae",
            "id": 12703337,
            "node_id": "MDQ6VXNlcjEyNzAzMzM3",
            "avatar_url": "https://avatars.githubusercontent.com/u/12703337?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jaliyae",
            "html_url": "https://github.com/jaliyae",
            "followers_url": "https://api.github.com/users/jaliyae/followers",
            "following_url": "https://api.github.com/users/jaliyae/following{/other_user}",
            "gists_url": "https://api.github.com/users/jaliyae/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jaliyae/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jaliyae/subscriptions",
            "organizations_url": "https://api.github.com/users/jaliyae/orgs",
            "repos_url": "https://api.github.com/users/jaliyae/repos",
            "events_url": "https://api.github.com/users/jaliyae/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jaliyae/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2019-05-09T06:10:06Z",
        "updated_at": "2019-05-09T06:10:06Z",
        "author_association": "NONE",
        "body": "This code was ported from a previous caffe2 based implementation as it is. Hope we can fix it for good.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/490757218/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/491475960",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/508#issuecomment-491475960",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/508",
        "id": 491475960,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MTQ3NTk2MA==",
        "user": {
            "login": "jignparm",
            "id": 13698702,
            "node_id": "MDQ6VXNlcjEzNjk4NzAy",
            "avatar_url": "https://avatars.githubusercontent.com/u/13698702?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jignparm",
            "html_url": "https://github.com/jignparm",
            "followers_url": "https://api.github.com/users/jignparm/followers",
            "following_url": "https://api.github.com/users/jignparm/following{/other_user}",
            "gists_url": "https://api.github.com/users/jignparm/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jignparm/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jignparm/subscriptions",
            "organizations_url": "https://api.github.com/users/jignparm/orgs",
            "repos_url": "https://api.github.com/users/jignparm/repos",
            "events_url": "https://api.github.com/users/jignparm/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jignparm/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2019-05-11T03:35:07Z",
        "updated_at": "2019-05-11T03:35:07Z",
        "author_association": "CONTRIBUTOR",
        "body": "I'm looking into generating reference models for each of the aggregation functions, to verify the implementation. Will update on this thread shortly.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/491475960/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/492089048",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/508#issuecomment-492089048",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/508",
        "id": 492089048,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MjA4OTA0OA==",
        "user": {
            "login": "jignparm",
            "id": 13698702,
            "node_id": "MDQ6VXNlcjEzNjk4NzAy",
            "avatar_url": "https://avatars.githubusercontent.com/u/13698702?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/jignparm",
            "html_url": "https://github.com/jignparm",
            "followers_url": "https://api.github.com/users/jignparm/followers",
            "following_url": "https://api.github.com/users/jignparm/following{/other_user}",
            "gists_url": "https://api.github.com/users/jignparm/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/jignparm/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/jignparm/subscriptions",
            "organizations_url": "https://api.github.com/users/jignparm/orgs",
            "repos_url": "https://api.github.com/users/jignparm/repos",
            "events_url": "https://api.github.com/users/jignparm/events{/privacy}",
            "received_events_url": "https://api.github.com/users/jignparm/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2019-05-14T05:54:44Z",
        "updated_at": "2019-05-14T05:54:44Z",
        "author_association": "CONTRIBUTOR",
        "body": "@aldanor , thanks for the great comments. Besides the confusion in that section (I think the variable names are carried over from the classifier, which don't always apply for regression), I tried out several scikit-learn tree algorithms, including  RandomForestRegressor and ExtraTreesRegressor. Most of the models from sciki-learn use either SUM or AVERAGE, which work successfully.\r\n\r\nFor MIN and MAX aggregation functions, the individual tree scores were not being preserved, so the computation was not correct. I've updated the functions in the PR below.\r\n\r\nRegarding the comment for the `+=` operators, they are executed only 1 time. It's to add `base_values` the final computed tree-ensemble score. They only need to be executed once, because **ProcessTreeNode()** already computes the sum over all leaves, for all targets. The only computation left is the aggregation.\r\n\r\nPlease review the fix in#1022.\r\n\r\nBelow is a sample of how to generate tree models from scikit-learn, in case others are interested in scoring tree ensembles using OnnxRuntime.\r\n\r\n**Sample code using Scikit-Learn**\r\n\r\n\t# Copyright (c) Microsoft Corporation. All rights reserved.\r\n\t# Licensed under the MIT License.\r\n\timport numpy\r\n\tfrom sklearn.pipeline import Pipeline\r\n\tfrom sklearn.ensemble import RandomForestClassifier\r\n\tfrom sklearn.ensemble import RandomForestRegressor\r\n\tfrom sklearn.ensemble import ExtraTreesRegressor\r\n\r\n\tnumpy.random.seed(0)\r\n\tX = [[0, 1], [1, 1], [2, 0]]\r\n\tX = numpy.array(X, dtype=numpy.float32)\r\n\t# 1 target\r\n\ty = numpy.array([100, -10, 50], dtype=numpy.float32)\r\n\r\n\tprint (\"X=\", X);\r\n\tprint (\"y=\", y);\r\n\r\n\tpipe = Pipeline([('rf', ExtraTreesRegressor(n_estimators=5))])\r\n\tpipe.fit(X, y)\r\n\tprint(\"predict with pipeline\\n\", pipe.predict(X))\r\n\r\n\t### Convert model\r\n\tfrom skl2onnx.common.data_types import Int64TensorType, FloatTensorType, StringTensorType, DictionaryType, SequenceType\r\n\tfrom skl2onnx import convert_sklearn\r\n\tmodel_onnx = convert_sklearn(pipe, 'pipeline_lightgbm',\r\n\t\t\t\t\t\t\t\t [('input', FloatTensorType([1, 2]))])\r\n\twith open(\"TreeEnsembleRegressor.onnx\", \"wb\") as f:\r\n\t\tf.write(model_onnx.SerializeToString())\r\n\r\n\t### Score with onnxruntime.\r\n\r\n\timport onnxruntime as rt\r\n\timport numpy\r\n\tsess = rt.InferenceSession(\"TreeEnsembleRegressor.onnx\")\r\n\tpred_onx = sess.run(None, {\"input\": X.astype(numpy.float32)})\r\n\tprint(\"predict with onnxruntime\\n\", [x[0] for x in pred_onx[0]])\r\n\r\n\r\nGive the following output results and results ONNX model.\r\n\r\n**Sample Output**\r\n   X= [[0. 1.]\r\n    [1. 1.]\r\n    [2. 0.]]\r\n   y= [100. -10.  50.]\r\n   predict with pipeline\r\n    [100. -10.  50.]\r\n   predict with onnxruntime\r\n    [100.0, -10.0, 50.0]\r\n\r\n**Resulting Model**\r\n![SampleTreeEnsembleRegressor](https://user-images.githubusercontent.com/13698702/57662474-32af0b00-75df-11e9-9c74-25cc105f198e.png)\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/492089048/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/492796241",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/508#issuecomment-492796241",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/508",
        "id": 492796241,
        "node_id": "MDEyOklzc3VlQ29tbWVudDQ5Mjc5NjI0MQ==",
        "user": {
            "login": "aldanor",
            "id": 2418513,
            "node_id": "MDQ6VXNlcjI0MTg1MTM=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2418513?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/aldanor",
            "html_url": "https://github.com/aldanor",
            "followers_url": "https://api.github.com/users/aldanor/followers",
            "following_url": "https://api.github.com/users/aldanor/following{/other_user}",
            "gists_url": "https://api.github.com/users/aldanor/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/aldanor/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/aldanor/subscriptions",
            "organizations_url": "https://api.github.com/users/aldanor/orgs",
            "repos_url": "https://api.github.com/users/aldanor/repos",
            "events_url": "https://api.github.com/users/aldanor/events{/privacy}",
            "received_events_url": "https://api.github.com/users/aldanor/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2019-05-15T19:42:32Z",
        "updated_at": "2019-05-15T19:42:32Z",
        "author_association": "NONE",
        "body": "@jignparm Thanks for fixing this - looks good now! (also the more tests the better)",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/492796241/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]