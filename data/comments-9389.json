[
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/951163919",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-951163919",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 951163919,
        "node_id": "IC_kwDOCVq1mM44sZwP",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-10-25T17:54:09Z",
        "updated_at": "2021-10-25T17:54:09Z",
        "author_association": "MEMBER",
        "body": "@mfuntowicz,  the function name was changed to change_graph_inputs_to_int32() in 1.9.0 (see https://github.com/microsoft/onnxruntime/pull/8927), could you double check that you are using 1.9.0 (You might need uninstall nightly package first).\r\n\r\nIf 1.9.0 has the problem, could you also try our nightly package 'https://test.pypi.org/project/ort-nightly/'. Let me know if it still have issue.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/951163919/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/951405399",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-951405399",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 951405399,
        "node_id": "IC_kwDOCVq1mM44tUtX",
        "user": {
            "login": "mfuntowicz",
            "id": 2241520,
            "node_id": "MDQ6VXNlcjIyNDE1MjA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2241520?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mfuntowicz",
            "html_url": "https://github.com/mfuntowicz",
            "followers_url": "https://api.github.com/users/mfuntowicz/followers",
            "following_url": "https://api.github.com/users/mfuntowicz/following{/other_user}",
            "gists_url": "https://api.github.com/users/mfuntowicz/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mfuntowicz/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mfuntowicz/subscriptions",
            "organizations_url": "https://api.github.com/users/mfuntowicz/orgs",
            "repos_url": "https://api.github.com/users/mfuntowicz/repos",
            "events_url": "https://api.github.com/users/mfuntowicz/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mfuntowicz/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-10-25T23:11:24Z",
        "updated_at": "2021-10-25T23:11:24Z",
        "author_association": "CONTRIBUTOR",
        "body": "Hi @tianleiwu, \r\n\r\nThanks for the update.\r\n\r\nI did see the name change and tried both versions with different outcomes, but both were failing.\r\nI will rerun the test with the correct 1.9 API, also testing out nightly and will report here.\r\n\r\n🙏🏻 ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/951405399/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/951788602",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-951788602",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 951788602,
        "node_id": "IC_kwDOCVq1mM44uyQ6",
        "user": {
            "login": "mfuntowicz",
            "id": 2241520,
            "node_id": "MDQ6VXNlcjIyNDE1MjA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2241520?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mfuntowicz",
            "html_url": "https://github.com/mfuntowicz",
            "followers_url": "https://api.github.com/users/mfuntowicz/followers",
            "following_url": "https://api.github.com/users/mfuntowicz/following{/other_user}",
            "gists_url": "https://api.github.com/users/mfuntowicz/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mfuntowicz/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mfuntowicz/subscriptions",
            "organizations_url": "https://api.github.com/users/mfuntowicz/orgs",
            "repos_url": "https://api.github.com/users/mfuntowicz/repos",
            "events_url": "https://api.github.com/users/mfuntowicz/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mfuntowicz/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-10-26T10:12:48Z",
        "updated_at": "2021-10-26T10:12:48Z",
        "author_association": "CONTRIBUTOR",
        "body": "@tianleiwu just tested with the correct method call: \r\n\r\n```python\r\n\r\noptimization_options = FusionOptions(\"bert\")\r\noptimization_options.enable_embed_layer_norm = True\r\n\r\noptimized_graph = optimize_model(\r\n    input=model_path.as_posix(),\r\n    model_type=export_config.topology.onnx.optimizer,\r\n    num_heads=model_config.num_attention_heads,\r\n    hidden_size=model_config.hidden_size,\r\n    opt_level=export_config.topology.onnx.optimization_level,\r\n    use_gpu=export_config.hardware.kind == HardwareKind.GPU,\r\n    optimization_options=optimization_options,\r\n)\r\n\r\noptimized_graph.change_graph_inputs_to_int32()\r\n...\r\n\r\n# Error happens here when trying to save the model, \r\noptimized_graph.save_model_to_file(\r\n    optimized_model_path.as_posix(), use_external_data_format=use_external_data_format\r\n)\r\n```\r\n\r\n\r\nOutput: \r\n\r\n```\r\n  File \"python3.8/site-packages/onnxruntime/transformers/onnx_model.py\", line 868, in save_model_to_file\r\n    self.topological_sort()\r\n  File \"python3.8/site-packages/onnxruntime/transformers/onnx_model.py\", line 864, in topological_sort\r\n    OnnxModel.graph_topological_sort(self.model.graph)\r\n  File \"python3.8/site-packages/onnxruntime/transformers/onnx_model.py\", line 856, in graph_topological_sort\r\n    assert (end == len(graph.node)), \"Graph is not a DAG\"\r\nAssertionError: Graph is not a DAG\r\n```\r\n\r\n\r\nRegarding `ort-nightly` I'm not able to install it: \r\n\r\n```bash\r\n(hf) mfuntowicz@DESKTOP-ND7AIJL:~/$ pip install -i https://test.pypi.org/simple/ ort-nightly\r\nLooking in indexes: https://test.pypi.org/simple/\r\nCollecting ort-nightly\r\n  Downloading https://test-files.pythonhosted.org/packages/e3/45/c1efcb7e2c2aae5caa2581ce61118023774cd1ae8e8c8b56fa24a4653200/ort_nightly-1.9.0.dev20210922001-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (4.8 MB)\r\n     |████████████████████████████████| 4.8 MB 9.8 MB/s\r\nCollecting protobuf\r\n  Downloading https://test-files.pythonhosted.org/packages/d8/59/82a663cc4e3e66eeada8f4d0b30a706f8b71e11d1d2ce6efc10326868b41/protobuf-3.19.0-py2.py3-none-any.whl (162 kB)\r\n     |████████████████████████████████| 162 kB 8.4 MB/s\r\nRequirement already satisfied: numpy>=1.16.6 in /usr/lib/python3/dist-packages (from ort-nightly) (1.17.4)\r\nERROR: Could not find a version that satisfies the requirement flatbuffers (from ort-nightly) (from versions: none)\r\nERROR: No matching distribution found for flatbuffers (from ort-nightly)\r\n```\r\n\r\nIs there anything I should try?",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/951788602/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/958908435",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-958908435",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 958908435,
        "node_id": "IC_kwDOCVq1mM45J8gT",
        "user": {
            "login": "mfuntowicz",
            "id": 2241520,
            "node_id": "MDQ6VXNlcjIyNDE1MjA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2241520?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mfuntowicz",
            "html_url": "https://github.com/mfuntowicz",
            "followers_url": "https://api.github.com/users/mfuntowicz/followers",
            "following_url": "https://api.github.com/users/mfuntowicz/following{/other_user}",
            "gists_url": "https://api.github.com/users/mfuntowicz/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mfuntowicz/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mfuntowicz/subscriptions",
            "organizations_url": "https://api.github.com/users/mfuntowicz/orgs",
            "repos_url": "https://api.github.com/users/mfuntowicz/repos",
            "events_url": "https://api.github.com/users/mfuntowicz/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mfuntowicz/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-03T10:54:59Z",
        "updated_at": "2021-11-03T10:54:59Z",
        "author_association": "CONTRIBUTOR",
        "body": "@tianleiwu I just tested with a fresh build from master branch and these 3 models are crashing with the above assertion.\r\n\r\n```python\r\nassert (end == len(graph.node)), \"Graph is not a DAG\"\r\nAssertionError: Graph is not a DAG\r\n```\r\n\r\nI'm digging a bit to see if I can spot anything. Will report here if I find anything.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/958908435/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/959762265",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-959762265",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 959762265,
        "node_id": "IC_kwDOCVq1mM45NM9Z",
        "user": {
            "login": "mfuntowicz",
            "id": 2241520,
            "node_id": "MDQ6VXNlcjIyNDE1MjA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2241520?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mfuntowicz",
            "html_url": "https://github.com/mfuntowicz",
            "followers_url": "https://api.github.com/users/mfuntowicz/followers",
            "following_url": "https://api.github.com/users/mfuntowicz/following{/other_user}",
            "gists_url": "https://api.github.com/users/mfuntowicz/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mfuntowicz/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mfuntowicz/subscriptions",
            "organizations_url": "https://api.github.com/users/mfuntowicz/orgs",
            "repos_url": "https://api.github.com/users/mfuntowicz/repos",
            "events_url": "https://api.github.com/users/mfuntowicz/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mfuntowicz/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-03T17:31:52Z",
        "updated_at": "2021-11-03T17:31:52Z",
        "author_association": "CONTRIBUTOR",
        "body": "Ok, dig a little bit more, I'm not sure but it seems some depdencies are not visited through the topological sort: \r\n\r\n![image](https://user-images.githubusercontent.com/2241520/140158288-58860912-b061-41da-b8cd-6f2b44c40ede.png)\r\n\r\nAnd the following check: \r\n\r\n```python\r\nassert (end == len(graph.node)), \"Graph is not a DAG\"\r\n```\r\n\r\nfails because `end=60` and `len(graph.node) = 65`.\r\n\r\nThen if you look at the `deps_count`  list debugger view above, you see 5 nodes still have dependencies which haven't been visited, thus leading to the assertion being trigged.",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/959762265/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/969202585",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-969202585",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 969202585,
        "node_id": "IC_kwDOCVq1mM45xNuZ",
        "user": {
            "login": "tianleiwu",
            "id": 30328909,
            "node_id": "MDQ6VXNlcjMwMzI4OTA5",
            "avatar_url": "https://avatars.githubusercontent.com/u/30328909?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/tianleiwu",
            "html_url": "https://github.com/tianleiwu",
            "followers_url": "https://api.github.com/users/tianleiwu/followers",
            "following_url": "https://api.github.com/users/tianleiwu/following{/other_user}",
            "gists_url": "https://api.github.com/users/tianleiwu/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/tianleiwu/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/tianleiwu/subscriptions",
            "organizations_url": "https://api.github.com/users/tianleiwu/orgs",
            "repos_url": "https://api.github.com/users/tianleiwu/repos",
            "events_url": "https://api.github.com/users/tianleiwu/events{/privacy}",
            "received_events_url": "https://api.github.com/users/tianleiwu/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-15T18:37:16Z",
        "updated_at": "2021-11-15T18:53:03Z",
        "author_association": "MEMBER",
        "body": "@mfuntowicz. The error usually means that the graph is invalid. If you save the model without topological sort, you might observe graph is not DAG. Could you share the ONNX if you cannot resolve it by upgrading packages?\r\n\r\nI did not reproduce the issue with master branch in Window. Steps I used:\r\n```\r\npython tools\\ci_build\\build.py --config Debug --build_dir build/Cpu_Debug --build_shared_lib --cmake_generator \"Visual Studio 16 2019\" --build_wheel --skip_tests\r\n\r\npip install build\\Cpu_Debug\\Debug\\Debug\\dist\\onnxruntime-1.10.0-cp36-cp36m-win_amd64.whl --force-reinstall\r\n\r\npython -m transformers.onnx -m sentence-transformers/all-MiniLM-L6-v2 --opset 12 --feature default .\r\n\r\npython test.py\r\n```\r\n\r\nThe content of test.py:\r\n```\r\nfrom transformers import AutoTokenizer, AutoModel\r\nfrom onnxruntime.transformers.optimizer import optimize_model\r\ntokenizer = AutoTokenizer.from_pretrained('sentence-transformers/all-MiniLM-L6-v2')\r\n\r\nmodel = AutoModel.from_pretrained('sentence-transformers/all-MiniLM-L6-v2')\r\nmodel_config = model.config\r\n\r\nfrom onnxruntime.transformers.fusion_options import FusionOptions\r\noptimization_options = FusionOptions(\"bert\")\r\n\r\noptimized_graph = optimize_model(\r\n    input=\"model.onnx\",\r\n    model_type=\"bert\",\r\n    num_heads=model_config.num_attention_heads,\r\n    hidden_size=model_config.hidden_size,\r\n    opt_level=99,\r\n    use_gpu=True,\r\n    optimization_options=optimization_options,\r\n)\r\n\r\noptimized_graph.convert_float_to_float16(keep_io_types=True)\r\noptimized_graph.change_graph_inputs_to_int32()\r\noptimized_graph.save_model_to_file(\r\n     \"model_opt.onnx\", use_external_data_format=False,\r\n)\r\n```\r\n\r\nIn my machine, the optimized model was generated correctly. My environment is like the following (from `python -m onnxruntime.transformers.machine_info`)\r\n```\r\n  \"os\": \"Windows-10-10.0.22000-SP0\",\r\n  \"python\": \"3.6.10.final.0 (64 bit)\",\r\n  \"packages\": {\r\n    \"transformers\": \"4.12.3\",\r\n    \"torch\": \"1.9.0+cpu\",          # PyTorch 1.10.0 is also tested.\r\n    \"tensorflow\": \"2.3.0\",\r\n    \"sympy\": \"1.6\",\r\n    \"protobuf\": \"3.19.1\",\r\n    \"onnxruntime\": \"1.10.0\",\r\n    \"numpy\": \"1.19.5\",\r\n    \"flatbuffers\": \"2.0\",\r\n    \"onnxconverter-common\": \"1.9.0\",\r\n    \"onnx\": \"1.10.2\"\r\n  },\r\n```\r\n\r\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/969202585/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/972157475",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-972157475",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 972157475,
        "node_id": "IC_kwDOCVq1mM458fIj",
        "user": {
            "login": "mfuntowicz",
            "id": 2241520,
            "node_id": "MDQ6VXNlcjIyNDE1MjA=",
            "avatar_url": "https://avatars.githubusercontent.com/u/2241520?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mfuntowicz",
            "html_url": "https://github.com/mfuntowicz",
            "followers_url": "https://api.github.com/users/mfuntowicz/followers",
            "following_url": "https://api.github.com/users/mfuntowicz/following{/other_user}",
            "gists_url": "https://api.github.com/users/mfuntowicz/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mfuntowicz/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mfuntowicz/subscriptions",
            "organizations_url": "https://api.github.com/users/mfuntowicz/orgs",
            "repos_url": "https://api.github.com/users/mfuntowicz/repos",
            "events_url": "https://api.github.com/users/mfuntowicz/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mfuntowicz/received_events",
            "type": "User",
            "site_admin": false
        },
        "created_at": "2021-11-17T22:26:55Z",
        "updated_at": "2021-11-17T22:26:55Z",
        "author_association": "CONTRIBUTOR",
        "body": "Thanks @tianleiwu I will test with the same setup than you reported and post the results here 🙏🏻 ",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/972157475/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    },
    {
        "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1100852257",
        "html_url": "https://github.com/microsoft/onnxruntime/issues/9389#issuecomment-1100852257",
        "issue_url": "https://api.github.com/repos/microsoft/onnxruntime/issues/9389",
        "id": 1100852257,
        "node_id": "IC_kwDOCVq1mM5Bnawh",
        "user": {
            "login": "stale[bot]",
            "id": 26384082,
            "node_id": "MDM6Qm90MjYzODQwODI=",
            "avatar_url": "https://avatars.githubusercontent.com/in/1724?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/stale%5Bbot%5D",
            "html_url": "https://github.com/apps/stale",
            "followers_url": "https://api.github.com/users/stale%5Bbot%5D/followers",
            "following_url": "https://api.github.com/users/stale%5Bbot%5D/following{/other_user}",
            "gists_url": "https://api.github.com/users/stale%5Bbot%5D/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/stale%5Bbot%5D/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/stale%5Bbot%5D/subscriptions",
            "organizations_url": "https://api.github.com/users/stale%5Bbot%5D/orgs",
            "repos_url": "https://api.github.com/users/stale%5Bbot%5D/repos",
            "events_url": "https://api.github.com/users/stale%5Bbot%5D/events{/privacy}",
            "received_events_url": "https://api.github.com/users/stale%5Bbot%5D/received_events",
            "type": "Bot",
            "site_admin": false
        },
        "created_at": "2022-04-17T10:54:01Z",
        "updated_at": "2022-04-17T10:54:01Z",
        "author_association": "NONE",
        "body": "This issue has been automatically marked as stale due to inactivity and will be closed in 7 days if no further activity occurs. If further support is needed, please provide an update and/or more details.\n",
        "reactions": {
            "url": "https://api.github.com/repos/microsoft/onnxruntime/issues/comments/1100852257/reactions",
            "total_count": 0,
            "+1": 0,
            "-1": 0,
            "laugh": 0,
            "hooray": 0,
            "confused": 0,
            "heart": 0,
            "rocket": 0,
            "eyes": 0
        },
        "performed_via_github_app": null
    }
]